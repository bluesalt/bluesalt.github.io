<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: avro | Jeff Li]]></title>
  <link href="http://bluesalt.github.io/tags/avro/atom.xml" rel="self"/>
  <link href="http://bluesalt.github.io/"/>
  <updated>2014-04-20T11:23:23+08:00</updated>
  <id>http://bluesalt.github.io/</id>
  <author>
    <name><![CDATA[Jeff Li]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Avro Cookbook : Part III]]></title>
    <link href="http://bluesalt.github.io/blog/2014/04/08/avro-cookbook-part-iii/"/>
    <updated>2014-04-08T17:24:45+08:00</updated>
    <id>http://bluesalt.github.io/blog/2014/04/08/avro-cookbook-part-iii</id>
    <content type="html"><![CDATA[<h2>Recipe 6: Serialize data as JSON data</h2>

<p>In <a href="http://jeffli.me/blog/2014/02/06/avro-cookbook-part-i/">Avro Cookbook : part I</a>, if you open the file <code>/tmp/log</code> created by recipe 3, you would find that it is definitely not a human readable text format. Avro provides the encoder/decoder mechanism which helps to serial the data to text format as JSON data. Actually, if I want to serial the POJOs to JSON data, I would rather use <a href="https://code.google.com/p/google-gson/">Google Gson</a>. Anyway, this is a post about Avro, right ?</p>
<div class="highlight"><pre><code class="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSerializeToJson</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
   <span class="n">ByteArrayOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
   <span class="n">Schema</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">ReflectData</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getSchema</span><span class="o">(</span><span class="n">LogEntry3</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

   <span class="n">Encoder</span> <span class="n">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EncoderFactory</span><span class="o">().</span><span class="na">jsonEncoder</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">outputStream</span><span class="o">);</span>
   <span class="n">DatumWriter</span><span class="o">&lt;</span><span class="n">LogEntry3</span><span class="o">&gt;</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReflectDatumWriter</span><span class="o">&lt;&gt;(</span><span class="n">schema</span><span class="o">);</span>

   <span class="n">LogEntry3</span> <span class="n">entry1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogEntry3</span><span class="o">(</span><span class="s">&quot;Jeff&quot;</span><span class="o">,</span> <span class="s">&quot;readme.md&quot;</span><span class="o">,</span> <span class="s">&quot;192.168.4.1&quot;</span><span class="o">);</span>
   <span class="n">LogEntry3</span> <span class="n">entry2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogEntry3</span><span class="o">(</span><span class="s">&quot;John&quot;</span><span class="o">,</span> <span class="s">&quot;readme.txt&quot;</span><span class="o">,</span> <span class="s">&quot;192.168.4.2&quot;</span><span class="o">);</span>

   <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">entry1</span><span class="o">,</span> <span class="n">encoder</span><span class="o">);</span>
   <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">entry2</span><span class="o">,</span> <span class="n">encoder</span><span class="o">);</span>
   <span class="n">encoder</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

   <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">outputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div>
<p>Refer to the <a href="http://localhost:4000/blog/2014/04/05/avro-cookbook-part-ii/">Avro Cookbook : Part II</a> for the what class <code>LogEntry3</code> looks like. Here is the output:
<code>json
{&quot;name&quot;:&quot;Jeff&quot;,&quot;resource&quot;:&quot;readme.md&quot;,&quot;ip&quot;:&quot;192.168.4.1&quot;}
{&quot;name&quot;:&quot;John&quot;,&quot;resource&quot;:&quot;readme.txt&quot;,&quot;ip&quot;:&quot;192.168.4.2&quot;}
</code></p>

<h2>Recipe 7: Deserialize JSON data</h2>
<div class="highlight"><pre><code class="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDeserializeFromJson</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
   <span class="n">String</span> <span class="n">input</span> <span class="o">=</span> <span class="s">&quot;{\&quot;name\&quot;:\&quot;Jeff\&quot;,\&quot;resource\&quot;:\&quot;readme.md\&quot;,\&quot;ip\&quot;:\&quot;192.168.4.1\&quot;}&quot;</span> <span class="o">+</span>
           <span class="s">&quot;{\&quot;name\&quot;:\&quot;John\&quot;,\&quot;resource\&quot;:\&quot;readme.txt\&quot;,\&quot;ip\&quot;:\&quot;192.168.4.2\&quot;}&quot;</span><span class="o">;</span>

   <span class="n">ByteArrayInputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
   <span class="n">Schema</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">ReflectData</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getSchema</span><span class="o">(</span><span class="n">LogEntry3</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

   <span class="n">JsonDecoder</span> <span class="n">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DecoderFactory</span><span class="o">().</span><span class="na">jsonDecoder</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">inputStream</span><span class="o">);</span>
   <span class="n">DatumReader</span><span class="o">&lt;</span><span class="n">GenericRecord</span><span class="o">&gt;</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GenericDatumReader</span><span class="o">&lt;&gt;(</span><span class="n">schema</span><span class="o">);</span>
   <span class="n">GenericRecord</span> <span class="n">entry</span><span class="o">;</span>
   <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="n">entry</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">decoder</span><span class="o">);</span>
         <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">EOFException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>If you look at the code carefully, you will find several interesting things. </p>

<p>First, there is no explicit separator between every JSON record. That means the Avro JSON decoder can decode the JSON data in the form of <strong>stream</strong>. This could be very helpful when you have to deserialize a whole bunch of JSON records without any explicit separator between records.</p>

<p>Second, when parsing the JSON data, the generic reader <code>DatumReader&lt;GenericRecord&gt;</code> instead of specific reader <code>DatumReader&lt;LogEntry3&gt;</code> is used. I tried to use the specific reader but it was not able to work with the error:
<pre>
org.apache.avro.AvroTypeException: Expected start-union. Got VALUE_STRING
    at org.apache.avro.io.JsonDecoder.error(JsonDecoder.java:697)
    at org.apache.avro.io.JsonDecoder.readIndex(JsonDecoder.java:441)
    at org.apache.avro.io.ResolvingDecoder.doAction(ResolvingDecoder.java:229)
    at org.apache.avro.io.parsing.Parser.advance(Parser.java:88)
    at org.apache.avro.io.ResolvingDecoder.readIndex(ResolvingDecoder.java:206)
    at org.apache.avro.generic.GenericDatumReader.read(GenericDatumReader.java:155)
    at org.apache.avro.generic.GenericDatumReader.readField(GenericDatumReader.java:193)
    at org.apache.avro.reflect.ReflectDatumReader.readField(ReflectDatumReader.java:230)
    at org.apache.avro.generic.GenericDatumReader.readRecord(GenericDatumReader.java:183)
    at org.apache.avro.generic.GenericDatumReader.read(GenericDatumReader.java:151)
    at org.apache.avro.generic.GenericDatumReader.read(GenericDatumReader.java:142)
</pre>
It turned out that the Avro JSON decoder can only parse JSON data like this
<code>json
{&quot;name&quot;:&quot;Jeff&quot;,&quot;resource&quot;:{&quot;string&quot;:&quot;readme.md&quot;},&quot;ip&quot;:{&quot;string&quot;:&quot;192.168.4.1&quot;}}
{&quot;name&quot;:&quot;John&quot;,&quot;resource&quot;:{&quot;string&quot;:&quot;readme.txt&quot;},&quot;ip&quot;:{&quot;string&quot;:&quot;192.168.4.2&quot;}}
</code>
but will not work on data like this
<code>json
{&quot;name&quot;: &quot;Jeff&quot;, &quot;resource&quot;: &quot;readme.md&quot;, &quot;ip&quot;: &quot;192.168.4.1&quot;}
{&quot;name&quot;: &quot;John&quot;, &quot;resource&quot;: &quot;readme.txt&quot;, &quot;ip&quot;: &quot;192.168.4.2&quot;}
</code>
After googling the issue, I found this: <a href="http://grokbase.com/t/avro/user/1345c5t7h1/issue-writing-union-in-avro">Issue writing union in avro</a>. So my suggestion is that don&#39;t use Avro for json serialization and deserialization if you have other choices. </p>

<h2>Recipe 8: Serialize array in JSON</h2>
<div class="highlight"><pre><code class="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSerializeArray</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="n">Schema</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="o">.</span><span class="na">createArray</span><span class="o">(</span><span class="n">ReflectData</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getSchema</span><span class="o">(</span><span class="n">LogEntry3</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
   <span class="n">GenericData</span><span class="o">.</span><span class="na">Array</span><span class="o">&lt;</span><span class="n">LogEntry3</span><span class="o">&gt;</span> <span class="n">logs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GenericData</span><span class="o">.</span><span class="na">Array</span><span class="o">&lt;&gt;(</span><span class="mi">2</span><span class="o">,</span> <span class="n">schema</span><span class="o">);</span>
   <span class="n">logs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">LogEntry3</span><span class="o">(</span><span class="s">&quot;Jeff&quot;</span><span class="o">,</span> <span class="s">&quot;readme.md&quot;</span><span class="o">,</span> <span class="s">&quot;192.168.5.1&quot;</span><span class="o">));</span>
   <span class="n">logs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">LogEntry3</span><span class="o">(</span><span class="s">&quot;John&quot;</span><span class="o">,</span> <span class="s">&quot;readme.txt&quot;</span><span class="o">,</span> <span class="s">&quot;192.168.5.2&quot;</span><span class="o">));</span>

   <span class="n">ByteArrayOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
   <span class="n">Encoder</span> <span class="n">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EncoderFactory</span><span class="o">().</span><span class="na">jsonEncoder</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">outputStream</span><span class="o">);</span>
   <span class="n">DatumWriter</span><span class="o">&lt;</span><span class="n">GenericData</span><span class="o">.</span><span class="na">Array</span><span class="o">&lt;</span><span class="n">LogEntry3</span><span class="o">&gt;&gt;</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReflectDatumWriter</span><span class="o">&lt;&gt;(</span><span class="n">schema</span><span class="o">);</span>
   <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">logs</span><span class="o">,</span> <span class="n">encoder</span><span class="o">);</span>
   <span class="n">encoder</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

   <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">outputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div>
<p>In the code above, not code generation is required, the <code>LogEntry3</code> is just a normal Java class. The serialized data would be
<code>json
[{&quot;name&quot;:&quot;Jeff&quot;,&quot;resource&quot;:&quot;readme.md&quot;,&quot;ip&quot;:&quot;192.168.5.1&quot;},{&quot;name&quot;:&quot;John&quot;,&quot;resource&quot;:&quot;readme.txt&quot;,&quot;ip&quot;:&quot;192.168.5.2&quot;}]
</code>
However, if the type of element of the array is generated from schema defintion(See <a href="http://localhost:4000/blog/2014/02/06/avro-cookbook-part-i/">Recipe 2</a>), the output would be different:
<code>json
[{&quot;name&quot;:&quot;Jeff&quot;,&quot;resource&quot;:{&quot;string&quot;:&quot;readme.md&quot;},&quot;ip&quot;:{&quot;string&quot;:&quot;192.168.5.1&quot;}},{&quot;name&quot;:&quot;John&quot;,&quot;resource&quot;:{&quot;string&quot;:&quot;readme.txt&quot;},&quot;ip&quot;:{&quot;string&quot;:&quot;192.168.5.2&quot;}}]
</code>
Still, I will not choose Avro to serialize data to JSON if I can use gson. However, this recipe is intended to demonstrate how to serialize a array without code generation from predefined schema. </p>

<h2>Recipe 9: Deserialize JSON array data</h2>
<div class="highlight"><pre><code class="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDeserializeArray</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
   <span class="n">Schema</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="o">.</span><span class="na">createArray</span><span class="o">(</span><span class="n">ReflectData</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getSchema</span><span class="o">(</span><span class="n">LogEntry3</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
   <span class="n">String</span> <span class="n">input</span> <span class="o">=</span> <span class="s">&quot;[{\&quot;name\&quot;:\&quot;Jeff\&quot;,\&quot;resource\&quot;:\&quot;readme.md\&quot;,\&quot;ip\&quot;:\&quot;192.168.5.1\&quot;},{\&quot;name\&quot;:\&quot;John\&quot;,\&quot;resource\&quot;:\&quot;readme.txt\&quot;,\&quot;ip\&quot;:\&quot;192.168.5.2\&quot;}]&quot;</span><span class="o">;</span>
   <span class="n">Decoder</span> <span class="n">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DecoderFactory</span><span class="o">().</span><span class="na">jsonDecoder</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
   <span class="n">DatumReader</span><span class="o">&lt;</span><span class="n">GenericData</span><span class="o">.</span><span class="na">Array</span><span class="o">&lt;</span><span class="n">GenericData</span><span class="o">.</span><span class="na">Record</span><span class="o">&gt;&gt;</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GenericDatumReader</span><span class="o">&lt;&gt;(</span><span class="n">schema</span><span class="o">);</span>
   <span class="n">GenericData</span><span class="o">.</span><span class="na">Array</span><span class="o">&lt;</span><span class="n">GenericData</span><span class="o">.</span><span class="na">Record</span><span class="o">&gt;</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">decoder</span><span class="o">);</span>
   <span class="n">GenericData</span><span class="o">.</span><span class="na">Record</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">logs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
   <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>Note, we can use only generic reader, have not figured out how to use a specific reader yet. Maybe it would be ok for the binary encoder to use specific reader.</p>

<h2>Recipe 10: Deserialize data stream</h2>

<p>The word <strong>stream</strong> means that the size of the source data is unknown. For example. if you want to serialize data like this
<pre>
[
   {
      &quot;name&quot;:&quot;Jeff&quot;,
      &quot;resource&quot;:&quot;readme.md&quot;,
      &quot;ip&quot;:&quot;192.168.5.1&quot;
   },
   {
      &quot;name&quot;:&quot;John&quot;,
      &quot;resource&quot;:&quot;readme.txt&quot;,
      &quot;ip&quot;:&quot;192.168.5.2&quot;
   }
][
   {
      &quot;name&quot;:&quot;Joe&quot;,
      &quot;resource&quot;:&quot;readme.md&quot;,
      &quot;ip&quot;:&quot;192.168.5.3&quot;
   },
   {
      &quot;name&quot;:&quot;James&quot;,
      &quot;resource&quot;:&quot;readme.txt&quot;,
      &quot;ip&quot;:&quot;192.168.5.4&quot;
   }
]
</pre>
The data have several unusual characteristics due to which gson can not be simply applied. 
 * The whole data is not a valid JSON. Instead it is JSON records set. Besides, the size of data could be very large.
 * There is no explicit separator between records. If the records are separated by character such as <code>\n</code>, then one record can be read and parsed easily. </p>

<p>The format of the data is so poor which should be avoided in practice. However, sometimes, we ourselves are just the data consumers. We can parse the data with Avro like this:
```java
@Test
public void testDeserializeStream() throws Exception {
   Schema schema = Schema.createArray(ReflectData.get().getSchema(LogEntry3.class));
   String input = &quot;[{&quot;name&quot;:&quot;Jeff&quot;,&quot;resource&quot;:&quot;readme.md&quot;,&quot;ip&quot;:&quot;192.168.5.1&quot;},{&quot;name&quot;:&quot;John&quot;,&quot;resource&quot;:&quot;readme.txt&quot;,&quot;ip&quot;:&quot;192.168.5.2&quot;}][{&quot;name&quot;:&quot;Joe&quot;,&quot;resource&quot;:&quot;readme.md&quot;,&quot;ip&quot;:&quot;192.168.5.3&quot;},{&quot;name&quot;:&quot;James&quot;,&quot;resource&quot;:&quot;readme.txt&quot;,&quot;ip&quot;:&quot;192.168.5.4&quot;}]
&quot;;
   Decoder decoder = new DecoderFactory().jsonDecoder(schema, input);
   DatumReader<GenericData.Array<LogEntry3>&gt; reader = new GenericDatumReader&lt;&gt;(schema);
   GenericData.Array<LogEntry3> parsedRecords;</p>

<p>int count = 0;
   while (true) {
      try {
         // We can iterate the parsedRecords to get every individual record
         parsedRecords = reader.read(null, decoder);
         count += parsedRecords.size();
      } catch (EOFException e) {
         break;
      }
   }</p>

<p>Assert.assertEquals(count, 4);
}
```</p>

<h2>Summary</h2>

<p>This post is the last part of the three part series on Avro. To be honest, I myself use Avro rarely and I am not a Avro expert, thus the code examples may not be the most appropriate. They are just intended to help the starters to play with Avro quickly. Anyone who uses Avro frequently should spend more time on looking deeper into the Avro framework. It would be great if they are helpful to you!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Avro Cookbook : Part II]]></title>
    <link href="http://bluesalt.github.io/blog/2014/04/05/avro-cookbook-part-ii/"/>
    <updated>2014-04-05T18:31:35+08:00</updated>
    <id>http://bluesalt.github.io/blog/2014/04/05/avro-cookbook-part-ii</id>
    <content type="html"><![CDATA[<h2>Recipe 5: Serialize data without Code Generation</h2>

<p>In formal recipes, before using Avro to serialize/deserialize data, schema files have to be defined to be leveraged by Avro code generation facility to generate the Java classes. This is also recommended when using Avro in Java. However, it is not required. Actually, you can parse the schema on the fly without code generation.</p>

<h3>Parse Schema from String</h3>

<p>The schema looks like this:
<code>json
{
 &quot;namespace&quot;: &quot;me.jeffli.avrosamples.model&quot;,
 &quot;type&quot;: &quot;record&quot;,
 &quot;name&quot;: &quot;LogEntry2&quot;,
 &quot;fields&quot;: [
     {&quot;name&quot;: &quot;name&quot;, &quot;type&quot;: &quot;string&quot;},
     {&quot;name&quot;: &quot;resource&quot;,  &quot;type&quot;: [&quot;string&quot;, &quot;null&quot;]},
     {&quot;name&quot;: &quot;ip&quot;, &quot;type&quot;: [&quot;string&quot;, &quot;null&quot;]}
 ]
}
</code>
Define the schema as a Java String:
<pre>
String schemaDesc = &quot;{\n&quot; +
           &quot; \&quot;namespace\&quot;: \&quot;me.jeffli.avrosamples.model\&quot;,\n&quot; +
           &quot; \&quot;type\&quot;: \&quot;record\&quot;,\n&quot; +
           &quot; \&quot;name\&quot;: \&quot;LogEntry2\&quot;,\n&quot; +
           &quot; \&quot;fields\&quot;: [\n&quot; +
           &quot;     {\&quot;name\&quot;: \&quot;name\&quot;, \&quot;type\&quot;: \&quot;string\&quot;},\n&quot; +
           &quot;     {\&quot;name\&quot;: \&quot;resource\&quot;,  \&quot;type\&quot;: [\&quot;string\&quot;, \&quot;null\&quot;]},\n&quot; +
           &quot;     {\&quot;name\&quot;: \&quot;ip\&quot;, \&quot;type\&quot;: [\&quot;string\&quot;, \&quot;null\&quot;]}\n&quot; +
           &quot; ]\n&quot; +
           &quot;}&quot;;
</pre></p>

<p>Then the code to serialize the data would be this:
```java
@Test
public void testSerializeOnTheFly() throws IOException {
   Schema schema = new Schema.Parser().parse(schemaDesc);
   GenericRecord entry1 = new GenericData.Record(schema);
   entry1.put(&quot;name&quot;, &quot;Jeffrey&quot;);
   entry1.put(&quot;resource&quot;, &quot;README&quot;);
   entry1.put(&quot;ip&quot;, &quot;192.168.2.1&quot;);</p>

<p>GenericRecord entry2 = new GenericData.Record(schema);
   entry2.put(&quot;name&quot;, &quot;Johnson&quot;);
   entry2.put(&quot;resource&quot;, &quot;readme.markdown&quot;);
   entry2.put(&quot;ip&quot;, &quot;192.168.2.2&quot;);</p>

<p>DatumWriter<GenericRecord> datumWriter = new GenericDatumWriter&lt;&gt;(schema);
   DataFileWriter<GenericRecord> dataFileWriter = new DataFileWriter&lt;&gt;(datumWriter);
   File file = new File(&quot;/tmp/log2&quot;);
   dataFileWriter.create(schema, file);</p>

<p>dataFileWriter.append(entry1);
   dataFileWriter.append(entry2);
   dataFileWriter.close();
}
```
From the example, we can see that we don&#39;t need to define any external schema file and no external Java classed are generated.</p>

<h3>Parse Schema from Disk File</h3>

<p>In the above example, we parse the schema from String. Since the schema is defined with JSON language, it is cumbersome to define the schema as a Java String. Fortunately Avro Schema.Paser also provides other API to parse the schema from disk file or existing Java class :</p>
<div class="highlight"><pre><code class="java"><span class="n">Schema</span> <span class="n">schema</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Schema</span><span class="o">.</span><span class="na">Parser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;src/test/resources/LogEntry2.avsc&quot;</span><span class="o">));</span>
</code></pre></div>
<h3>Parse Schema from Existing Java Class</h3>

<p>Per the JSON Schema definition, a equivalent Java class would look like this:
```java
public class LogEntry3 {
   private String name;
   private String resource;
   private String ip;</p>

<p>public LogEntry3(String name, String resource, String ip) {
      this.name = name;
      this.resource = resource;
      this.ip = ip;
   }</p>

<p>public String getName() {
      return name;
   }</p>

<p>public void setName(String name) {
      this.name = name;
   }</p>

<p>public String getResource() {
      return resource;
   }</p>

<p>public void setResource(String resource) {
      this.resource = resource;
   }</p>

<p>public String getIp() {
      return ip;
   }</p>

<p>public void setIp(String ip) {
      this.ip = ip;
   }
}
```</p>

<p>Then the Schema can be fetched easily:
<code>java
Schema schema = ReflectData.get().getSchema(LogEntry3.class);
</code>
What is more, you can use ReflectDatumWriter to append specific type objects to the target:
```java
@Test
public void testSerializeData() throws IOException {
   Schema schema = ReflectData.get().getSchema(LogEntry3.class);
   File file = new File(&quot;/tmp/log3&quot;);
   LogEntry3 entry1 = new LogEntry3(&quot;Jeff&quot;, &quot;readme.txt&quot;, &quot;192.168.3.1&quot;);
   LogEntry3 entry2 = new LogEntry3(&quot;John&quot;, &quot;readme.md&quot;, &quot;192.168.3.2&quot;);</p>

<p>ReflectDatumWriter<LogEntry3> reflectDatumWriter = new ReflectDatumWriter&lt;&gt;(schema);
   DataFileWriter<LogEntry3> writer = new DataFileWriter&lt;&gt;(reflectDatumWriter).create(schema, file);
   writer.append(entry1);
   writer.append(entry2);
   writer.close();
}
```</p>

<h2>Recipe 6: Deserialize data without Code Generation</h2>

<p>Deserializing data without code generation is pretty easy. The only difference with Recipe 4 is how it get the <strong>schema</strong>. Thus the ways to fetch schemas in Recipe 5 are also applicable in this recipe. Here is only the example to load schema from disk file. I am pretty sure that you can finish the rest code. It should be noted that if the schema is parsed on the fly without any code generation, then when deserializing the data, you can only use the generic datum reader even if you attempt with <strong>ReflectDatumReader</strong>. </p>
<div class="highlight"><pre><code class="java"><span class="nd">@Test</span><span class="o">(</span><span class="n">dependsOnMethods</span> <span class="o">=</span> <span class="s">&quot;testSerializeOnTheFly&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDeserializeOnTheFly</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="n">Schema</span> <span class="n">schema</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Schema</span><span class="o">.</span><span class="na">Parser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;src/test/resources/LogEntry2.avsc&quot;</span><span class="o">));</span>
   <span class="n">DatumReader</span><span class="o">&lt;</span><span class="n">GenericRecord</span><span class="o">&gt;</span> <span class="n">datumReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GenericDatumReader</span><span class="o">&lt;&gt;(</span><span class="n">schema</span><span class="o">);</span>
   <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/log2&quot;</span><span class="o">);</span>
   <span class="n">DataFileReader</span><span class="o">&lt;</span><span class="n">GenericRecord</span><span class="o">&gt;</span> <span class="n">dataFileReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataFileReader</span><span class="o">&lt;&gt;(</span><span class="n">file</span><span class="o">,</span> <span class="n">datumReader</span><span class="o">);</span>
   <span class="n">GenericRecord</span> <span class="n">entry</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
   <span class="k">while</span> <span class="o">(</span><span class="n">dataFileReader</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">entry</span> <span class="o">=</span> <span class="n">dataFileReader</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Avro Cookbook : Part I]]></title>
    <link href="http://bluesalt.github.io/blog/2014/02/06/avro-cookbook-part-i/"/>
    <updated>2014-02-06T15:49:00+08:00</updated>
    <id>http://bluesalt.github.io/blog/2014/02/06/avro-cookbook-part-i</id>
    <content type="html"><![CDATA[<p>Avro is a data serialization framework. It is an Apache project led by Doug Cutting who is also the author of several other open source projects such as Hadoop, Lucene. Recently I need to leverage Avro to serialize/deserialize some data, however, I found its document is too poor, at least too poor for newbies like me who don&#39;t have much experience on data exchange format frameworks. </p>

<p>In fact, it is very easy to understand what Avro can do. It helps to convert Java objects into bytes and vice versa. The key information the framework needs to know is the format of the date, namely &#39;Schema&#39; in Avro. In this article, I won&#39;t spend any time on explaining what Avro is. </p>

<h2>Recipe 1: Create a Maven Avro Project</h2>

<p>Intellij IDEA is my favorite Java IDE. The free Community edition has less features than the commercial Ultimate edition, however, great experience may be gained when the free community IDEA works with Maven. They complete each other. So the examples in this article will use Maven and Intellij IDEA as the IDE. Besides, <strong>TestNG</strong> instead of JUnit will be used as the test framework.</p>

<h3>Initialize the project structure</h3>

<ul>
<li>Create an project with quickstart archetype:
<code>
mvn archetype:generate -DgroupId=me.jeffli -DartifactId=avrosamples -Dversion=0.01 -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false
</code></li>
</ul>

<h3>Tweak the pom.xml</h3>

<ul>
<li><p>Add Avro dependency:
<code>xml
&lt;dependency&gt;
&lt;groupId&gt;org.apache.avro&lt;/groupId&gt;
&lt;artifactId&gt;avro&lt;/artifactId&gt;
&lt;version&gt;1.7.5&lt;/version&gt;
&lt;/dependency&gt;
</code></p></li>
<li><p>Use Avro Maven plugin
<code>xml
&lt;plugin&gt;
&lt;groupId&gt;org.apache.avro&lt;/groupId&gt;
&lt;artifactId&gt;avro-maven-plugin&lt;/artifactId&gt;
&lt;version&gt;1.7.5&lt;/version&gt;
&lt;executions&gt;
  &lt;execution&gt;
     &lt;phase&gt;generate-sources&lt;/phase&gt;
     &lt;goals&gt;
        &lt;goal&gt;schema&lt;/goal&gt;
     &lt;/goals&gt;
     &lt;configuration&gt;
        &lt;!-- make sure the directory is created --&gt;
        &lt;sourceDirectory&gt;${project.basedir}/src/main/avro/&lt;/sourceDirectory&gt;
        &lt;outputDirectory&gt;${project.basedir}/src/main/java/&lt;/outputDirectory&gt;
     &lt;/configuration&gt;
  &lt;/execution&gt;
&lt;/executions&gt;
&lt;/plugin&gt;
</code></p></li>
</ul>

<p>It should be noted that the directory <code>${project.basedir}/src/main/avro/</code> must be created even it is empty at first. It is used to place the Avro schema files. The whole pom.xml has been posted to <a href="https://gist.github.com/bluesalt/9807306">github gist</a>.</p>

<h3>Import the project into Intellij IDEA</h3>

<p>IDEA provides full support to Maven, so it is very easy to import the Maven project as a IDEA project. Click &quot;Import Project&quot; in the &#39;Quick Start&#39; panel. I suggest enable the Maven Auto-Import feature of IDEA before completing the importing process.</p>

<h2>Recipe 2: Define a Schema</h2>

<p>Assume that you want to log every access of your server, to make it simple, we only define 3 attributes in a log entry, namely the username, resource and ip. So the schema can be defined as :
<code>json
{
 &quot;namespace&quot;: &quot;me.jeffli.avrosamples.model&quot;,
 &quot;type&quot;: &quot;record&quot;,
 &quot;name&quot;: &quot;LogEntry&quot;,
 &quot;fields&quot;: [
     {&quot;name&quot;: &quot;name&quot;, &quot;type&quot;: &quot;string&quot;},
     {&quot;name&quot;: &quot;resource&quot;,  &quot;type&quot;: [&quot;string&quot;, &quot;null&quot;]},
     {&quot;name&quot;: &quot;ip&quot;, &quot;type&quot;: [&quot;string&quot;, &quot;null&quot;]}
 ]
}
</code></p>

<p>Save the content as <code>${project.basedir}/src/main/avro/LogEntry.avsc</code>. After running <code>mvn compile</code>, a Java class <code>me.jeffli.avrosamples.model.LogEntry</code> will be generated automatically thank to the Avro Maven plugin.  </p>

<h2>Recipe 3: Serialize the Log Data to Disk File</h2>

<p>Assume we want to store the log data to a disk file <code>/tmp/log</code>. The code snippet would be like this:
```java
@Test
public void testSerializeLogEntries() throws IOException {
   LogEntry entry1 = new LogEntry();
   entry1.setName(&quot;Jeff&quot;);
   entry1.setResource(&quot;readme.txt&quot;);
   entry1.setIp(&quot;192.168.1.1&quot;);</p>

<p>LogEntry entry2 = new LogEntry();
   entry2.setName(&quot;John&quot;);
   entry2.setResource(&quot;readme.md&quot;);
   entry2.setIp(&quot;192.168.1.2&quot;);</p>

<p>DatumWriter<LogEntry> logEntryDatumWriter = new SpecificDatumWriter&lt;&gt;(LogEntry.class);
   DataFileWriter<LogEntry> dataFileWriter = new DataFileWriter&lt;&gt;(logEntryDatumWriter);
   File file = new File(&quot;/tmp/log&quot;);
   dataFileWriter.create(entry1.getSchema(), file);</p>

<p>dataFileWriter.append(entry1);
   dataFileWriter.append(entry2);</p>

<p>dataFileWriter.close();
}
```  </p>

<h2>Recipe 4: Deserialize the Log Data from Disk File</h2>

<p>Assume you need to parse the log data from disk files <code>/tmp/log</code>. Then the code snippet would be:
<code>java
@Test (dependsOnMethods = &quot;testSerializeLogEntries&quot;)
public void testDeSerializeLogEntries() throws IOException {
   DatumReader&lt;LogEntry&gt; logEntryDatumReader = new SpecificDatumReader&lt;&gt;(LogEntry.class);
   File file = new File(&quot;/tmp/log&quot;);
   DataFileReader&lt;LogEntry&gt; dataFileReader = new DataFileReader&lt;&gt;(file, logEntryDatumReader);
   LogEntry entry = null;
   while (dataFileReader.hasNext()) {
      entry = dataFileReader.next(entry);
      System.out.println(entry);
   }
}
</code>   </p>
]]></content>
  </entry>
  
</feed>
