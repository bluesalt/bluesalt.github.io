<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: ansible | Jeff Li]]></title>
  <link href="http://bluesalt.github.io/tags/ansible/atom.xml" rel="self"/>
  <link href="http://bluesalt.github.io/"/>
  <updated>2017-05-21T07:06:19+08:00</updated>
  <id>http://bluesalt.github.io/</id>
  <author>
    <name><![CDATA[Jeff Li]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[A Pitfall of Vagrant When Using Ansible's wait_for Module]]></title>
    <link href="http://bluesalt.github.io/blog/2017/05/19/a-pitfall-of-vagrant-when-using-ansibles-wait-for-module/"/>
    <updated>2017-05-19T22:09:31+08:00</updated>
    <id>http://bluesalt.github.io/blog/2017/05/19/a-pitfall-of-vagrant-when-using-ansibles-wait-for-module</id>
    <content type="html"><![CDATA[<ul id="markdown-toc">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#triage">Triage</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<h3 id="introduction">Introduction</h3>
<p>Vagrant and Ansible are used to manage my development environment which is really wonderful. Recently, I have written a Ansible playbook which would reboot the VM during Vagrant provisioning. Check <a href="https://www.vagrantup.com/docs/provisioning/ansible.html">here</a> to see how Vagrant works together with Ansible. Besides, there are tasks left which are expected to continue after the VM comes back. It is easy to find a solution in Ansible</p>

<!--more-->

<p>
```yaml
—
- name: reboot the system
  shell: sleep 2 &amp;&amp; shutdown -r now “Ansible updates triggered”
  async: 1
  poll: 0
  become: yes
  ignore_errors: true</p>

<ul>
  <li>name: waiting for server to come back
wait_for:
  port: “{{ ansible_ssh_port | default(22) }}”
  host: “{{ ansible_ssh_host | default(inventory_hostname) }}”
  state: started
  delay: 10
  timeout: 60
delegate_to: localhost
become: no
```
</li>
</ul>

<p>This is the standard way to reboot and wait for a host to come back through polling in Ansible. However, it doesn’t work as expected. Technically, it works with <a href="https://github.com/vagrant-libvirt/vagrant-libvirt">libvirt</a> provider but not the built-in <a href="https://www.vagrantup.com/docs/virtualbox/">VirtualBox</a> provider.</p>

<ul>
  <li>Output of Ansible shows that the <code>wait_for</code> task is successful</li>
  <li>SSH connection failure occurs in <code>wait_for</code> task’s following task</li>
  <li>VirtualBox UI tells that the VM is still booting when <code>wait_for</code> task is done</li>
</ul>

<h3 id="triage">Triage</h3>

<p>What makes me confused is that VirtualBox tells that VM is still booting but the <code>wait_for</code> module has finished successfully. Disclose SSH connection failure from following task means that the VM is not ready yet. It seems that something is wrong with <code>wait_for</code> module.</p>

<p>For the first try, the value of <code>delay</code> option of <code>wait_for</code> task was set to a longer time like <code>30</code> which means Ansible will block for 30 seconds before it starts to check if the host is back or not. Every task got executed successfully and VirtualBox UI showed that the VM had been up. Though every thing seems to be OK, the workaround didn’t make sense because that is not how <code>wait_for</code> module works. It is supposed to poll the status of the VM and wait until port 22 of the VM is ready. However, the result tell that <code>wait_for</code> module will return immediately whenever it start to check the status.</p>

<p>Next, enable <a href="https://www.vagrantup.com/docs/provisioning/ansible_common.html#verbose">Ansible’s verbose mode in Vagrant</a>. From the output of <code>wait_for</code> module we can find</p>

<p><code>
{
   "changed":false,
   "elapsed":10,
   "invocation":{
      "module_args":{
         "connect_timeout":5,
         "delay":10,
         "exclude_hosts":null,
         "host":"127.0.0.1",
         "path":null,
         "port":2222,
         "search_regex":null,
         "state":"started",
         "timeout":60
      },
      "module_name":"wait_for"
   },
   "path":null,
   "port":2222,
   "search_regex":null,
   "state":"started"
}
</code></p>

<p>Wait, why are the values of host and port <code>127.0.0.1</code> and <code>2222</code>? Aren’t they supposed to be the ip of VM and 22? The output means that 2 of Ansible’s facts, <code>ansible_ssh_port</code> and <code>ansible_ssh_host</code>, are interpreted unexpectedly. If not specified, Ansible’s inventory file will be <a href="https://www.vagrantup.com/docs/provisioning/ansible_intro.html#the-inventory-file">generated by Vagrant automatically</a>. The content of inventory file generated by Vagrant is</p>

<p>```
# Generated by Vagrant</p>

<p>VM_NAME ansible_ssh_host=127.0.0.1 ansible_ssh_port=2222 ansible_ssh_private_key_file=VM_DIRECTORY/.vagrant/machines/VM_NAME/virtualbox/private_key
```</p>

<p>Because Vagrant use a <a href="https://www.vagrantup.com/docs/networking/forwarded_ports.html">forwarded port</a> to create SSH connection in VirtualBox, the host will be <code>127.0.0.1</code> and the port is a <code>2222</code> other than 22.</p>

<p>So, can we instruct Vagrant to generate the inventory file with the VM’s own address and port 22 by <a href="https://github.com/mitchellh/vagrant/issues/1922">disabling port forwarding</a>? Unfortunately, NO! You can disable any port <a href="https://github.com/mitchellh/vagrant/issues/474">except the forwarded SSH port in VirtualBox</a>. That is because Vagrant require a way to access and configure the VM through SSH and port forwarding is used with VirtualBox provider. The libvirt provider uses <a href="https://www.vagrantup.com/docs/networking/private_network.html">private network</a> to provide the SSH connection so the playbook works well.</p>

<p>The reason why <code>wait_for</code> module is able to finish successfully is that the forwarded port will be created before the VM is ready. Every time <code>wait_for</code> module starts to check the VM, it finds that the port is ready. In fact, only the host’s port is ready but the guest’s port is not.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Since the root cause has been found, there are several ways to fix it.</p>

<ol>
  <li>Provide a <a href="https://www.vagrantup.com/docs/provisioning/ansible_common.html#inventory_path">customized inventory file to Vagrant</a>. This is not a good practice because we should let Vagrant to manage as much stuff as possible.</li>
  <li>Pass the VM’s address and port to the playbook. Not good enough since hardcoded parameters should be avoided.</li>
  <li>Use the <code>search_regex</code> option of <code>wait_for</code> module. With the option, <code>wait_for</code> module will not just check if the port is ready, it will also try to read some data from the port and search if it matches the <code>search_regex</code>. After setting the <code>search_regex</code> option to <code>OpenSSH</code>, every one is happy now.</li>
</ol>

<p>Some lessons</p>

<ul>
  <li>Networking is really the must-know knowledge for Vagrant users.</li>
  <li>Ansible’s verbose mode is informative and should be turned on when something is abnormal.</li>
  <li>Let Vagrant to manage the environment as much as possible.</li>
</ul>

]]></content>
  </entry>
  
</feed>
